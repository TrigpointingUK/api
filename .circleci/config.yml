# Docs : https://circleci.com/docs/2.0/configuration-reference
# Orb: https://circleci.com/developer/orbs/orb/circleci/node
# Docker executor: https://circleci.com/docs/2.0/executor-types/
# Convenience Images: https://circleci.com/developer/images/image/cimg/node

version: 2.1

orbs:
  node: circleci/node@5.0.0
  codecov: codecov/codecov@3.2.2

jobs:
  api-unit-test:
    docker:
      - image: cimg/node:16.10
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run tests with JUnit as reporter
          command: npx jest --ci --runInBand --reporters=default --reporters=jest-junit
          no_output_timeout: 1m
          environment:
            JEST_JUNIT_OUTPUT_DIR: ./reports/junit/
      - store_test_results:
          path: ./reports/junit/
      - store_artifacts:
          path: ./reports/junit

  api-coverage:
    docker:
      - image: cimg/node:16.10
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run jest coverage
          command: npm run test:cov
          no_output_timeout: 1m
      - codecov/upload:
          when: always

  api-coverage-circleci:
    docker:
      - image: cimg/node:16.10
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run coverage tests
          command: npx jest --ci --runInBand --coverage
          no_output_timeout: 1m
      - codecov/upload:
          when: always

  api-build:
    docker:
      - image: google/cloud-sdk
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build image
          command: docker build . -t tuk-api
      - run:
          name: Push to Google Artifact Registry
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project trigpointinguk
            gcloud config list
            gcloud auth configure-docker europe-west1-docker.pkg.dev
            docker tag tuk-api europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:latest
            docker push europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:latest
            docker tag tuk-api europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_SHA1
            docker push europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_SHA1
            docker tag tuk-api europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_BUILD_NUM
            docker push europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_BUILD_NUM
            docker tag tuk-api europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_BRANCH
            docker push europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_BRANCH

  api-deploy-tme:
    docker:
      - image: google/cloud-sdk
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Retag image
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project trigpointinguk
            gcloud auth configure-docker europe-west1-docker.pkg.dev
            docker pull europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_SHA1
            docker tag europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_SHA1 europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:tme
            docker push europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:tme
      - run:
          name: Deploy to Cloud Run - api-tme
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project trigpointinguk
            gcloud config list
            gcloud auth configure-docker europe-west1-docker.pkg.dev
            gcloud run deploy api-tme \
              --image=europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_SHA1 \
              --region=europe-west1 \
              --allow-unauthenticated \
              --port=3000 \
              --memory=4Gi \
              --max-instances=2 \
              --min-instances=0 \
              --update-env-vars \
            MODE=DEV,\
            RUN_MIGRATIONS=true,\
            NEST_DEBUG=true,\
            AUTH0_ISSUER_URL=https://teasel.eu.auth0.com/,\
            AUTH0_AUDIENCE=https://api.trigpointing.me,\
            AUTH0_REDIRECT_URL=https://api.trigpointing.me/docs/oauth2-redirect.html,\
            NODE_TLS_REJECT_UNAUTHORIZED=0, \
              --update-secrets \
            POSTGRES_HOST=TME_POSTGRES_HOST:latest,\
            POSTGRES_PORT=TME_POSTGRES_PORT:latest,\
            POSTGRES_USER=TME_POSTGRES_USER:latest,\
            POSTGRES_PASSWORD=TME_POSTGRES_PASSWORD:latest,\
            POSTGRES_DATABASE=TME_POSTGRES_DATABASE:latest,\
            AUTH0_CLIENT_ID=TME_SWAGGER_AUTH0_CLIENT_ID:latest,\

  api-deploy-tuk:
    docker:
      - image: google/cloud-sdk
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Retag image
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project trigpointinguk
            gcloud auth configure-docker europe-west1-docker.pkg.dev
            docker pull europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_SHA1
            docker tag europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_SHA1 europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:tuk
            docker push europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:tuk

      - run:
          name: Deploy to Cloud Run - api-tuk
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project trigpointinguk
            gcloud config list
            gcloud auth configure-docker europe-west1-docker.pkg.dev
            gcloud run deploy api-tuk \
              --image=europe-west1-docker.pkg.dev/trigpointinguk/images/tuk-api:$CIRCLE_SHA1 \
              --region=europe-west1 \
              --allow-unauthenticated \
              --port=3000 \
              --memory=4Gi \
              --max-instances=4 \
              --min-instances=0 \
              --update-env-vars \
            MODE=DEV,\
            RUN_MIGRATIONS=true,\
            NEST_DEBUG=true,\
            AUTH0_ISSUER_URL=https://teasel.eu.auth0.com/,\
            AUTH0_AUDIENCE=https://api.trigpointing.me,\
            AUTH0_REDIRECT_URL=https://api.trigpointing.me/docs/oauth2-redirect.html,\
            NODE_TLS_REJECT_UNAUTHORIZED=0, \
              --update-secrets \
            POSTGRES_HOST=TME_POSTGRES_HOST:latest,\
            POSTGRES_PORT=TME_POSTGRES_PORT:latest,\
            POSTGRES_USER=TME_POSTGRES_USER:latest,\
            POSTGRES_PASSWORD=TME_POSTGRES_PASSWORD:latest,\
            POSTGRES_DATABASE=TME_POSTGRES_DATABASE:latest,\
            AUTH0_CLIENT_ID=TME_SWAGGER_AUTH0_CLIENT_ID:latest,\

workflows:
  oncommit:
    jobs:
      - api-unit-test
      - api-coverage
      - api-coverage-circleci
      - api-build
      - api-deploy-tme:
          requires:
            - api-unit-test
            - api-build
          filters:
            branches:
              ignore:
                - main
      - api-deploy-tuk:
          requires:
            - api-unit-test
            - api-build
          filters:
            branches:
              only:
                - main
